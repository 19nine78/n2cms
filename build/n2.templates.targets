<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="3.5">

	<!-- TEMPLATES -->

	<Target Name="Templates-Build">
		<MSBuild Projects="$(WebFolder)\N2.Templates.csproj" Properties="Configuration=$(Configuration);OutDir=$(TempFolder)" />
		<CallTarget Targets="Templates-Mvc-Build"/>
	</Target>

	<Target Name="Templates-Deploy" DependsOnTargets="Templates-Build;Rebuild-Core-BinFiles">
		<ItemGroup>
			<_TemplatesTempFiles Include="$(TempFolder)_PublishedWebsites\N2.Templates\**\*"/>
		</ItemGroup>

		<Copy SourceFiles="@(_TemplatesTempFiles)" DestinationFolder="$(DeployFolder)\Templates\wwwroot\%(RecursiveDir)" />
		<Delete Files="@(_TemplatesTempFiles)" ContinueOnError="true"/>
		<Copy SourceFiles="@(Core-BinFiles)" DestinationFolder="$(DeployFolder)\Templates\wwwroot\bin\" />
		<Copy SourceFiles="@(Core-EditFiles)" DestinationFolder="$(DeployFolder)\Templates\wwwroot\Edit\%(RecursiveDir)" />
		<Copy SourceFiles="@(TextFiles)" DestinationFolder="$(DeployFolder)\Templates" />
		<Copy SourceFiles="$(LibFolder)\n2.sqlite.db" DestinationFiles="$(DeployFolder)\Templates\wwwroot\App_Data\n2.sqlite.db" />
	</Target>

	<!-- MVC TEMPLATES -->
	<PropertyGroup>
		<Templates-Mvc-Folder>$(SrcFolder)\N2.Templates.Mvc</Templates-Mvc-Folder>
		<Templates-Mvc-Deploy-Folder>$(DeployFolder)\N2.Templates.Mvc</Templates-Mvc-Deploy-Folder>
	</PropertyGroup>

	<Target Name="Templates-Mvc-PrepareDependencies" DependsOnTargets="Rebuild-Core-BinFiles">
		<Copy SourceFiles="$(SrcFolder)\N2.Extensions\bin\N2.Extensions.dll; 
                       $(LibFolder)\Microsoft.Web.Mvc.dll; 
                       $(LibFolder)\System.Web.Mvc.dll;"
					DestinationFolder="$(Templates-Mvc-Folder)\Bin" />
		<Copy SourceFiles="@(Core-BinFiles)" DestinationFolder="$(Templates-Mvc-Folder)\Bin" />
		<Copy SourceFiles="@(Core-EditFiles)" DestinationFolder="$(Templates-Mvc-Folder)\Edit\%(RecursiveDir)" SkipUnchangedFiles="true" />
	</Target>
	
	<Target Name="Templates-Mvc-Build" DependsOnTargets="Templates-Mvc-PrepareDependencies">
		<MSBuild Projects="$(Templates-Mvc-Folder)\N2.Templates.Mvc.csproj" Properties="Configuration=$(Configuration);OutDir=$(TempFolder)" />
	</Target>

	<Target Name="Templates-Mvc-Deploy" DependsOnTargets="Templates-Mvc-Build;Rebuild-Core-BinFiles">
		<ItemGroup>
			<_TemplatesTempFiles Include="$(TempFolder)_PublishedWebsites\N2.Templates.Mvc\**\*"/>
		</ItemGroup>

		<Copy SourceFiles="@(_TemplatesTempFiles)" DestinationFolder="$(Templates-Mvc-Deploy-Folder)\%(RecursiveDir)" />
		<Delete Files="@(_TemplatesTempFiles)" ContinueOnError="true"/>
		<Copy SourceFiles="@(Core-BinFiles)" DestinationFolder="$(Templates-Mvc-Deploy-Folder)\bin\" />
		<Copy SourceFiles="@(Core-EditFiles)" DestinationFolder="$(Templates-Mvc-Deploy-Folder)\Edit\%(RecursiveDir)" />
		<Copy SourceFiles="@(TextFiles)" DestinationFolder="$(Templates-Mvc-Deploy-Folder)\" />
		<Copy SourceFiles="$(LibFolder)\n2.sqlite.db" DestinationFiles="$(Templates-Mvc-Deploy-Folder)\App_Data\n2.sqlite.db" />
	</Target>
	
	<!-- Other templates -->
	<Target Name="Addons-Deploy" DependsOnTargets="AddonCatalog-Deploy;Wiki-Deploy;Tagging-Deploy;TabPanel-Deploy">
	</Target>

	<Target Name="AddonCatalog-Build">
		<MSBuild Projects="$(WebFolder)\AddonCatalog.csproj" Properties="Configuration=$(Configuration);OutDir=$(TempFolder)" />
	</Target>
	<Target Name="AddonCatalog-Deploy" DependsOnTargets="AddonCatalog-Build">
		<ItemGroup>
			<_AddonCatalogTempFiles Include="$(TempFolder)_PublishedWebsites\AddonCatalog\**\*"/>
		</ItemGroup>
		<Copy SourceFiles="@(_AddonCatalogTempFiles)" DestinationFolder="$(DeployFolder)\Templates\Addons\AddonCatalog\%(RecursiveDir)"/>
		<Delete Files="@(_AddonCatalogTempFiles)" ContinueOnError="true" />
	</Target>

	<Target Name="Wiki-Build">
		<MSBuild Projects="$(WebFolder)\Wiki.csproj" Properties="Configuration=$(Configuration);OutDir=$(TempFolder)" />
	</Target>
	
	<Target Name="Wiki-Deploy" DependsOnTargets="Wiki-Build">
		<ItemGroup>
			<_WikiTempFiles Include="$(TempFolder)_PublishedWebsites\Wiki\**\*"/>
		</ItemGroup>
		<Copy SourceFiles="@(_WikiTempFiles)" DestinationFolder="$(DeployFolder)\Templates\Addons\Wiki\%(RecursiveDir)"/>
		<Delete Files="@(_WikiTempFiles)" ContinueOnError="true" />
	</Target>

	<Target Name="Tagging-Build">
		<MSBuild Projects="$(WebFolder)\Tagging.csproj" Properties="Configuration=$(Configuration);OutDir=$(TempFolder)" />
	</Target>

	<Target Name="Tagging-Deploy" DependsOnTargets="Tagging-Build">
		<ItemGroup>
			<_TaggingTempFiles Include="$(TempFolder)_PublishedWebsites\Tagging\**\*"/>
		</ItemGroup>
		<Copy SourceFiles="@(_TaggingTempFiles)" DestinationFolder="$(DeployFolder)\Templates\Addons\Tagging\%(RecursiveDir)"/>
		<Delete Files="@(_TaggingTempFiles)" ContinueOnError="true" />
	</Target>

	<Target Name="TabPanel-Build">
		<MSBuild Projects="$(WebFolder)\TabPanel.csproj" Properties="Configuration=$(Configuration);OutDir=$(TempFolder)" />
	</Target>

	<Target Name="TabPanel-Deploy" DependsOnTargets="TabPanel-Build">
		<ItemGroup>
			<_TabPanelTempFiles Include="$(TempFolder)_PublishedWebsites\TabPanel\**\*"/>
		</ItemGroup>
		<Copy SourceFiles="@(_TabPanelTempFiles)" DestinationFolder="$(DeployFolder)\Templates\Addons\TabPanel\%(RecursiveDir)"/>
		<Delete Files="@(_TabPanelTempFiles)" ContinueOnError="true" />
	</Target>
</Project>