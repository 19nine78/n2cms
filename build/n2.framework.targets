<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="3.5">

	<!-- Framework -->

	<ItemGroup>
		<Framework-Dependencies Include="$(LibFolder)\Castle*;
									$(LibFolder)\Iesi.Collections.dll;
									$(LibFolder)\log4net.dll;
									$(LibFolder)\NHibernate.dll;
									$(LibFolder)\NHibernate.Caches.SysCache2.dll;
									$(LibFolder)\System.Data.SQLite.dll"/>

		<TextFiles Include="$(DocFolder)\history.txt;
							$(DocFolder)\install.txt;
							$(DocFolder)\license.txt;
							$(DocFolder)\n2_readme.txt;
							$(DocFolder)\example.web.config" />

		<Snippets Include="$(SnippetsFolder)\*" />
	</ItemGroup>
	
	<!-- Build -->

	<Target Name="Framework-Build" DependsOnTargets="Framework-PrepareDependencies">
		<MSBuild Projects="$(SrcFolder)\N2.Sources-vs2008.sln" Properties="Configuration=$(Configuration);NHVersion=$(NHVersion)" />
	</Target>

	<!-- Prepare dependencies -->

	<Target Name="Framework-PrepareDependencies">
		<Copy SourceFiles="@(Framework-Dependencies)" DestinationFolder="$(WebFolder)\Bin\" />
	</Target>

	<Target Name="Framework-CreateItemGroups" DependsOnTargets="Framework-Build">
		<ItemGroup>
			<Framework-EditFiles Include="$(EditFolder)\**\*.as?x;
									 $(EditFolder)\**\*.master;
									 $(EditFolder)\**\*.resx;
									 $(EditFolder)\**\*.config;
									 $(EditFolder)\**\*.css;
									 $(EditFolder)\**\*.js;
									 $(EditFolder)\**\*.gif;$(EditFolder)\**\*.png;$(EditFolder)\**\*.jpg;$(EditFolder)\**\*.png;
									 $(EditFolder)\**\*.htm;$(EditFolder)\**\*.html"
								 Exclude="$(EditFolder)\**\*_src.js;" />
			<Framework-BinFiles Include="$(WebFolder)\Bin\*.dll;
										 $(WebFolder)\Bin\N2.xml;"
								Exclude="$(WebFolder)\Bin\N2.Templates*;
										 $(WebFolder)\Bin\AddonCatalog*;
										 $(WebFolder)\Bin\Demo*;
										 $(WebFolder)\Bin\MyAddon*;
										 $(WebFolder)\Bin\n2markdown*;
										 $(WebFolder)\Bin\Scrum*;
										 $(WebFolder)\Bin\TabPanel*;
										 $(WebFolder)\Bin\Tagging*;
										 $(WebFolder)\Bin\Wiki*;"/>
		</ItemGroup>
	</Target>
	
	<!-- Deploy -->

	<Target Name="Framework-Deploy" DependsOnTargets="Framework-CreateItemGroups">
		<Copy SourceFiles="@(Framework-BinFiles)" DestinationFolder="$(DeployFolder)\Framework\Bin" />
		<Copy SourceFiles="@(Framework-EditFiles)" DestinationFolder="$(DeployFolder)\Framework\Edit\%(RecursiveDir)" />
		<Copy SourceFiles="@(TextFiles)" DestinationFolder="$(DeployFolder)\Framework" />
	</Target>

	<Target Name="Framework-Zip" DependsOnTargets="Framework-Deploy">
		<ItemGroup>
			<ZipDeploy-Framework Include="$(DeployFolder)\Framework\**" />
		</ItemGroup>

		<Error Condition="'@(ZipDeploy-Framework)' == ''" Text="Nothing in '$(DeployFolder)\Framework'. Do deploy first." />

		<Zip Files="@(ZipDeploy-Framework)"       WorkingDirectory="$(DeployFolder)\Framework"              ZipFileName="$(DeployFolder)\CompiledRuntime.zip" />
	</Target>

</Project>